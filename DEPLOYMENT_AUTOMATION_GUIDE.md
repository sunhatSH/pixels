# è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº† Pixels Lambda å‡½æ•°çš„è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹ï¼ŒåŒ…æ‹¬ä»ä»£ç æäº¤åˆ° Lambda éƒ¨ç½²å’Œæµ‹è¯•çš„å®Œæ•´æ­¥éª¤ã€‚

## ç›®å½•

1. [æµç¨‹æ¦‚è¿°](#æµç¨‹æ¦‚è¿°)
2. [å‰ç½®æ¡ä»¶](#å‰ç½®æ¡ä»¶)
3. [é…ç½®å‚æ•°](#é…ç½®å‚æ•°)
4. [è¯¦ç»†æ­¥éª¤](#è¯¦ç»†æ­¥éª¤)
5. [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
6. [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

## æµç¨‹æ¦‚è¿°

è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹åŒ…å«ä»¥ä¸‹æ­¥éª¤ï¼š

```
1. Git ä»£ç æäº¤ä¸æ¨é€
   â†“
2. EC2 å®ä¾‹å‘ç°ä¸å¯åŠ¨ï¼ˆå¦‚éœ€è¦ï¼‰
   â†“
3. SSH è¿æ¥å¹¶æ‹‰å–æœ€æ–°ä»£ç 
   â†“
4. Maven ç¼–è¯‘é¡¹ç›®
   â†“
5. ä¸‹è½½ JAR æ–‡ä»¶åˆ°æœ¬åœ°
   â†“
6. ä¸Šä¼  JAR åˆ° S3
   â†“
7. åˆ›å»ºæˆ–æ›´æ–° Lambda å‡½æ•°
   â†“
8. æ‰§è¡Œæµ‹è¯•å¹¶éªŒè¯
```

## å‰ç½®æ¡ä»¶

### æœ¬åœ°ç¯å¢ƒè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: macOS
- **AWS CLI**: å·²å®‰è£…å¹¶é…ç½®ï¼ˆ`aws configure`ï¼‰
- **SSH å¯†é’¥**: `~/.ssh/pixels-key.pem`ï¼ˆæƒé™ï¼š600ï¼‰
- **Git**: å·²å®‰è£…å¹¶é…ç½®
- **jq**: JSON å¤„ç†å·¥å…·ï¼ˆå¯é€‰ï¼Œç”¨äºæ ¼å¼åŒ–è¾“å‡ºï¼‰

### AWS èµ„æºè¦æ±‚

- **EC2 å®ä¾‹**: 
  - å®ä¾‹ ID: `i-0e01b0d7947291b0b`
  - åŒºåŸŸ: `us-east-1`
  - ç”¨æˆ·: `ec2-user`
  - å·²å®‰è£…: Git, Maven, Java

- **S3 å­˜å‚¨æ¡¶**: 
  - æ¡¶å: `home-sunhao`
  - åŒºåŸŸ: `us-east-2`
  - å…·æœ‰è¯»å†™æƒé™

- **Lambda å‡½æ•°**: 
  - å‡½æ•°å: `pixels-scan-worker`
  - åŒºåŸŸ: `us-east-2`
  - IAM è§’è‰²: `PixelsLambdaRole`

### Git ä»“åº“

- **ä»“åº“åœ°å€**: `git@github.com:sunhaoSH/pixels.git`
- **åˆ†æ”¯**: `master`ï¼ˆæˆ– `main`ï¼‰
- **æ³¨æ„**: ç¡®ä¿ä½¿ç”¨ `sunhaoSH` ç”¨æˆ·çš„ä»“åº“ï¼Œä¸æ˜¯ `pixels` ç”¨æˆ·çš„ä»“åº“

## é…ç½®å‚æ•°

è„šæœ¬ä¸­å¯é…ç½®çš„å‚æ•°ï¼š

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `REPO_USER` | `sunhaoSH` | Git ä»“åº“ç”¨æˆ·å |
| `REPO_NAME` | `pixels` | Git ä»“åº“å |
| `BRANCH` | `master` | Git åˆ†æ”¯ |
| `SSH_KEY` | `~/.ssh/pixels-key.pem` | SSH ç§é’¥è·¯å¾„ |
| `EC2_INSTANCE_ID` | `i-0e01b0d7947291b0b` | EC2 å®ä¾‹ ID |
| `EC2_REGION` | `us-east-1` | EC2 æ‰€åœ¨åŒºåŸŸ |
| `EC2_USER` | `ec2-user` | EC2 ç”¨æˆ·å |
| `EC2_REPO_PATH` | `~/pixels` | EC2 ä¸Šä»“åº“è·¯å¾„ |
| `BUCKET_NAME` | `home-sunhao` | S3 å­˜å‚¨æ¡¶å |
| `LAMBDA_REGION` | `us-east-2` | Lambda æ‰€åœ¨åŒºåŸŸ |
| `FUNCTION_NAME` | `pixels-scan-worker` | Lambda å‡½æ•°å |
| `LAMBDA_ROLE_NAME` | `PixelsLambdaRole` | IAM è§’è‰²å |
| `LOCAL_JAR_PATH` | `./pixels-worker-lambda.jar` | æœ¬åœ° JAR æ–‡ä»¶è·¯å¾„ |

## è¯¦ç»†æ­¥éª¤

### æ­¥éª¤ 1: Git ä»£ç æäº¤ä¸æ¨é€

**æ“ä½œ**:
1. æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹
2. å¦‚æœæœ‰ï¼Œè‡ªåŠ¨æäº¤ï¼ˆä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºæäº¤ä¿¡æ¯ï¼‰
3. æ¨é€åˆ°è¿œç¨‹ä»“åº“

**éªŒè¯ä»“åº“åœ°å€**:
- è„šæœ¬ä¼šè‡ªåŠ¨æ£€æŸ¥ Git remote URL æ˜¯å¦ä¸º `sunhaoSH` ç”¨æˆ·çš„ä»“åº“
- å¦‚æœä¸æ˜¯ï¼Œä¼šæç¤ºå¹¶å…è®¸ä¿®æ­£

**æ³¨æ„äº‹é¡¹**:
- ä½¿ç”¨ `git add .` æ·»åŠ æ‰€æœ‰æ›´æ”¹ï¼ˆéµå¾ª `.gitignore` è§„åˆ™ï¼‰
- æäº¤ä¿¡æ¯åŒ…å«æ—¶é—´æˆ³ï¼Œä¾¿äºè¿½è¸ª

### æ­¥éª¤ 2: EC2 å®ä¾‹å‘ç°ä¸å¯åŠ¨

**åŠ¨æ€ IP è·å–**:
- ä½¿ç”¨ AWS CLI æŸ¥è¯¢æŒ‡å®šå®ä¾‹ ID çš„çŠ¶æ€
- è·å–å…¬ç½‘ IP åœ°å€ï¼ˆå¦‚æœå®ä¾‹æ­£åœ¨è¿è¡Œï¼‰

**å®ä¾‹çŠ¶æ€å¤„ç†**:
- **running**: ç›´æ¥è·å– IP å¹¶ç»§ç»­
- **stopped**: è‡ªåŠ¨å¯åŠ¨å®ä¾‹ï¼Œç­‰å¾…å¯åŠ¨å®Œæˆï¼ˆæœ€å¤š 5 åˆ†é’Ÿï¼‰
- **pending/stopping**: ç­‰å¾…çŠ¶æ€ç¨³å®š
- **terminated**: æŠ¥é”™å¹¶é€€å‡º

**ç­‰å¾…é€»è¾‘**:
- å®ä¾‹å¯åŠ¨åï¼Œç­‰å¾… SSH æœåŠ¡å°±ç»ªï¼ˆæœ€å¤šé‡è¯• 60 æ¬¡ï¼Œæ¯æ¬¡ 5 ç§’ï¼‰
- æ£€æŸ¥å®ä¾‹æ˜¯å¦è·å¾—å…¬ç½‘ IP

### æ­¥éª¤ 3: SSH è¿æ¥å¹¶æ‹‰å–ä»£ç 

**Git ä»“åº“éªŒè¯**:
- æ£€æŸ¥ EC2 ä¸Šçš„è¿œç¨‹ä»“åº“ URL
- å¦‚æœä¸æ˜¯ `sunhaoSH` ç”¨æˆ·çš„ä»“åº“ï¼Œè‡ªåŠ¨æ›´æ–°
- æ‰§è¡Œ `git pull` æ‹‰å–æœ€æ–°ä»£ç 

**è·¯å¾„æ£€æŸ¥**:
- ç¡®ä¿ `~/pixels` ç›®å½•å­˜åœ¨
- å¦‚æœä¸å­˜åœ¨ï¼Œè‡ªåŠ¨å…‹éš†ä»“åº“

### æ­¥éª¤ 4: Maven ç¼–è¯‘

**ç¼–è¯‘å‘½ä»¤**:
```bash
mvn clean package -DskipTests -pl pixels-turbo/pixels-worker-lambda -am
```

**è¾“å‡ºæ–‡ä»¶**:
- ä¸» JAR: `pixels-turbo/pixels-worker-lambda/target/pixels-worker-lambda-*.jar`
- ä¾èµ– JAR: `pixels-turbo/pixels-worker-lambda/target/pixels-worker-lambda-deps.jar`

**åˆå¹¶ JAR**ï¼ˆå¦‚æœå­˜åœ¨ deps JARï¼‰:
- åˆ›å»ºä¸´æ—¶ç›®å½•
- è§£å‹ä¸¤ä¸ª JAR æ–‡ä»¶å¹¶åˆå¹¶
- ç”Ÿæˆ Fat JAR: `pixels-worker-lambda-fat.jar`

### æ­¥éª¤ 5: ä¸‹è½½ JAR æ–‡ä»¶

**ä¸‹è½½æ–¹å¼**:
- ä½¿ç”¨ `scp` ä» EC2 ä¸‹è½½ JAR åˆ°æœ¬åœ°
- ä¿å­˜ä¸º `./pixels-worker-lambda.jar`

**æ–‡ä»¶æ£€æŸ¥**:
- éªŒè¯æ–‡ä»¶æ˜¯å¦ä¸‹è½½æˆåŠŸ
- æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆåº”è¯¥ > 0ï¼‰

### æ­¥éª¤ 6: ä¸Šä¼  JAR åˆ° S3

**ä¸Šä¼ å‘½ä»¤**:
```bash
aws s3 cp ./pixels-worker-lambda.jar \
  s3://home-sunhao/lambda/pixels-worker-lambda.jar \
  --region us-east-2
```

**éªŒè¯**:
- ä¸Šä¼ æˆåŠŸååˆ—å‡º S3 æ–‡ä»¶ä¿¡æ¯
- ç¡®è®¤æ–‡ä»¶å¤§å°å’Œæ—¶é—´æˆ³

### æ­¥éª¤ 7: åˆ›å»ºæˆ–æ›´æ–° Lambda å‡½æ•°

**å‡½æ•°å­˜åœ¨æ€§æ£€æŸ¥**:
- ä½¿ç”¨ `aws lambda get-function` æ£€æŸ¥å‡½æ•°æ˜¯å¦å­˜åœ¨

**å¦‚æœå‡½æ•°ä¸å­˜åœ¨**:
1. è·å– IAM è§’è‰² ARN
2. åˆ›å»º Lambda å‡½æ•°ï¼š
   ```bash
   aws lambda create-function \
     --function-name pixels-scan-worker \
     --runtime java21 \
     --role <ROLE_ARN> \
     --handler io.pixelsdb.pixels.worker.lambda.ScanWorker::handleRequest \
     --code S3Bucket=home-sunhao,S3Key=lambda/pixels-worker-lambda.jar \
     --architectures arm64 \
     --memory-size 4096 \
     --timeout 900
   ```
3. ç­‰å¾…å‡½æ•°å˜ä¸º `Active` çŠ¶æ€

**å¦‚æœå‡½æ•°å­˜åœ¨**:
1. æ›´æ–°å‡½æ•°ä»£ç ï¼š
   ```bash
   aws lambda update-function-code \
     --function-name pixels-scan-worker \
     --s3-bucket home-sunhao \
     --s3-key lambda/pixels-worker-lambda.jar
   ```
2. ç­‰å¾…æ›´æ–°å®Œæˆ

### æ­¥éª¤ 8: æ‰§è¡Œæµ‹è¯•

**æµ‹è¯•è¾“å…¥å‡†å¤‡**:
- ç”Ÿæˆæµ‹è¯• JSON payload
- åŒ…å«æ­£ç¡®çš„è¡¨ä¿¡æ¯ã€åˆ—åå’Œ S3 è·¯å¾„

**è°ƒç”¨ Lambda**:
```bash
aws lambda invoke \
  --function-name pixels-scan-worker \
  --payload file:///tmp/test-scan-input.json \
  --cli-binary-format raw-in-base64-out \
  --region us-east-2 \
  /tmp/lambda-response.json
```

**ç»“æœéªŒè¯**:
- æ£€æŸ¥å“åº” JSON
- æŸ¥çœ‹ CloudWatch Logs è·å–è¯¦ç»†æ—¥å¿—
- æå–æ€§èƒ½æŒ‡æ ‡ï¼ˆå¦‚æœå¯ç”¨ï¼‰

## é”™è¯¯å¤„ç†

è„šæœ¬ä½¿ç”¨ `set -e` åœ¨é‡åˆ°é”™è¯¯æ—¶ç«‹å³é€€å‡ºï¼Œä½†åŒ…å«ä»¥ä¸‹é”™è¯¯å¤„ç†æœºåˆ¶ï¼š

### 1. Git é”™è¯¯
- **é—®é¢˜**: æ— æƒé™æ¨é€
- **å¤„ç†**: æ£€æŸ¥ SSH å¯†é’¥æˆ– GitHub è®¿é—®ä»¤ç‰Œ

### 2. EC2 è¿æ¥é”™è¯¯
- **é—®é¢˜**: SSH è¿æ¥è¶…æ—¶
- **å¤„ç†**: 
  - æ£€æŸ¥å®‰å…¨ç»„æ˜¯å¦å…è®¸ SSHï¼ˆç«¯å£ 22ï¼‰
  - éªŒè¯ SSH å¯†é’¥æƒé™
  - ç¡®è®¤å®ä¾‹å·²å®Œå…¨å¯åŠ¨

### 3. ç¼–è¯‘é”™è¯¯
- **é—®é¢˜**: Maven ç¼–è¯‘å¤±è´¥
- **å¤„ç†**: 
  - æ£€æŸ¥ Java ç‰ˆæœ¬ï¼ˆéœ€è¦ Java 21ï¼‰
  - æ£€æŸ¥ä¾èµ–æ˜¯å¦å®Œæ•´
  - æŸ¥çœ‹ç¼–è¯‘æ—¥å¿—å®šä½é—®é¢˜

### 4. S3 ä¸Šä¼ é”™è¯¯
- **é—®é¢˜**: æƒé™ä¸è¶³æˆ–æ¡¶ä¸å­˜åœ¨
- **å¤„ç†**: 
  - éªŒè¯ IAM æƒé™
  - æ£€æŸ¥æ¡¶åå’ŒåŒºåŸŸæ˜¯å¦æ­£ç¡®

### 5. Lambda éƒ¨ç½²é”™è¯¯
- **é—®é¢˜**: è§’è‰²ä¸å­˜åœ¨æˆ–é…ç½®é”™è¯¯
- **å¤„ç†**: 
  - éªŒè¯ IAM è§’è‰²æ˜¯å¦å­˜åœ¨
  - æ£€æŸ¥è§’è‰²ä¿¡ä»»å…³ç³»
  - ç¡®è®¤è¿è¡Œæ—¶å’Œæ¶æ„é…ç½®æ­£ç¡®

## æ•…éšœæ’é™¤

### é—®é¢˜ 1: Git Remote URL ä¸æ­£ç¡®

**ç—‡çŠ¶**: è„šæœ¬æç¤ºä»“åº“åœ°å€ä¸æ˜¯ `sunhaoSH` ç”¨æˆ·çš„ä»“åº“

**è§£å†³**:
```bash
# æ‰‹åŠ¨æ›´æ–° remote URL
git remote set-url origin git@github.com:sunhaoSH/pixels.git

# éªŒè¯
git remote -v
```

### é—®é¢˜ 2: EC2 å®ä¾‹æ— æ³•å¯åŠ¨

**ç—‡çŠ¶**: å®ä¾‹ä¸€ç›´å¤„äº `pending` çŠ¶æ€

**è§£å†³**:
1. æ£€æŸ¥ AWS è´¦æˆ·é™åˆ¶ï¼ˆå®ä¾‹æ•°é‡ã€å®¹é‡ï¼‰
2. æ£€æŸ¥å®ä¾‹ç±»å‹æ˜¯å¦åœ¨å½“å‰åŒºåŸŸå¯ç”¨
3. æ‰‹åŠ¨åœ¨ AWS æ§åˆ¶å°æŸ¥çœ‹å®ä¾‹çŠ¶æ€

### é—®é¢˜ 3: SSH è¿æ¥å¤±è´¥

**ç—‡çŠ¶**: `Connection timed out` æˆ– `Permission denied`

**è§£å†³**:
```bash
# æ£€æŸ¥å¯†é’¥æƒé™
chmod 600 ~/.ssh/pixels-key.pem

# æµ‹è¯• SSH è¿æ¥
ssh -i ~/.ssh/pixels-key.pem ec2-user@<EC2_IP>

# æ£€æŸ¥å®‰å…¨ç»„ï¼ˆéœ€è¦ç«¯å£ 22 å¼€æ”¾ï¼‰
aws ec2 describe-security-groups --instance-ids i-0e01b0d7947291b0b
```

### é—®é¢˜ 4: Maven ç¼–è¯‘å¤±è´¥

**ç—‡çŠ¶**: `BUILD FAILURE` æˆ–ä¾èµ–ç¼ºå¤±

**è§£å†³**:
```bash
# åœ¨ EC2 ä¸Šæ£€æŸ¥ Java ç‰ˆæœ¬
java -version

# æ£€æŸ¥ Maven ç‰ˆæœ¬
mvn -version

# æ¸…ç†å¹¶é‡æ–°ç¼–è¯‘
mvn clean install -DskipTests
```

### é—®é¢˜ 5: Lambda å‡½æ•°åˆ›å»ºå¤±è´¥

**ç—‡çŠ¶**: `InvalidParameterValueException` æˆ– `ResourceConflictException`

**è§£å†³**:
1. æ£€æŸ¥ IAM è§’è‰²æ˜¯å¦å­˜åœ¨ï¼š
   ```bash
   aws iam get-role --role-name PixelsLambdaRole
   ```

2. éªŒè¯ S3 æ–‡ä»¶å­˜åœ¨ï¼š
   ```bash
   aws s3 ls s3://home-sunhao/lambda/pixels-worker-lambda.jar
   ```

3. æ£€æŸ¥è¿è¡Œæ—¶æ”¯æŒï¼š
   - ç¡®è®¤ `java21` åœ¨ç›®æ ‡åŒºåŸŸå¯ç”¨
   - ç¡®è®¤ `arm64` æ¶æ„æ”¯æŒ

### é—®é¢˜ 6: Lambda è°ƒç”¨å¤±è´¥

**ç—‡çŠ¶**: å‡½æ•°è¿”å›é”™è¯¯æˆ–è¶…æ—¶

**è§£å†³**:
1. æŸ¥çœ‹ CloudWatch Logs:
   ```bash
   aws logs tail /aws/lambda/pixels-scan-worker --follow
   ```

2. æ£€æŸ¥æµ‹è¯•æ•°æ®è·¯å¾„æ˜¯å¦æ­£ç¡®

3. éªŒè¯ IAM è§’è‰²æƒé™ï¼ˆS3 è¯»å†™ã€CloudWatch Logs å†™å…¥ï¼‰

## æ—¥å¿—è¾“å‡º

è„šæœ¬ä¼šè¾“å‡ºè¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š

- âœ… æˆåŠŸæ­¥éª¤æ ‡è®°
- âŒ é”™è¯¯æ ‡è®°
- ğŸ”„ è¿›è¡Œä¸­æ­¥éª¤æ ‡è®°
- ğŸ“‹ å…³é”®ä¿¡æ¯è¾“å‡º

æ‰€æœ‰æ“ä½œéƒ½ä¼šè®°å½•æ—¶é—´æˆ³ï¼Œä¾¿äºè¿½è¸ªæ‰§è¡Œè¿‡ç¨‹ã€‚

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å¹¶è¡Œæ“ä½œ**: å¯ä»¥è€ƒè™‘åœ¨ç¼–è¯‘æ—¶å¹¶è¡Œæ‰§è¡Œå…¶ä»–å‡†å¤‡æ­¥éª¤
2. **å¢é‡ç¼–è¯‘**: Maven ä¼šç¼“å­˜ä¾èµ–ï¼Œé‡å¤è¿è¡Œä¼šæ›´å¿«
3. **ç¼“å­˜ JAR**: å¦‚æœä»£ç æœªæ›´æ”¹ï¼Œå¯ä»¥è·³è¿‡ç¼–è¯‘æ­¥éª¤
4. **è¿æ¥æ± **: å¯¹äºé¢‘ç¹éƒ¨ç½²ï¼Œå¯ä»¥ä¿æŒ SSH è¿æ¥å¤ç”¨

## å®‰å…¨æ³¨æ„äº‹é¡¹

1. **SSH å¯†é’¥**: ç¡®ä¿å¯†é’¥æ–‡ä»¶æƒé™ä¸º 600ï¼Œä¸è¦æäº¤åˆ° Git
2. **AWS å‡­è¯**: ä½¿ç”¨ IAM ç”¨æˆ·è€Œé root è´¦æˆ·ï¼Œéµå¾ªæœ€å°æƒé™åŸåˆ™
3. **Git ä»“åº“**: ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ä»“åº“åœ°å€ï¼Œé¿å…ä»£ç æ³„éœ²
4. **S3 è®¿é—®**: ä½¿ç”¨ IAM ç­–ç•¥é™åˆ¶ S3 æ¡¶è®¿é—®èŒƒå›´

## é™„å½•

### å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

```bash
# æ£€æŸ¥ Git remote
git remote -v

# æŸ¥çœ‹ EC2 å®ä¾‹çŠ¶æ€
aws ec2 describe-instances --instance-ids i-0e01b0d7947291b0b

# å¯åŠ¨ EC2 å®ä¾‹
aws ec2 start-instances --instance-ids i-0e01b0d7947291b0b

# æŸ¥çœ‹ Lambda å‡½æ•°
aws lambda get-function --function-name pixels-scan-worker

# æŸ¥çœ‹ S3 æ–‡ä»¶
aws s3 ls s3://home-sunhao/lambda/

# æŸ¥çœ‹ CloudWatch Logs
aws logs tail /aws/lambda/pixels-scan-worker --follow
```

### é…ç½®æ–‡ä»¶ç¤ºä¾‹

å¯ä»¥åœ¨è„šæœ¬å¼€å¤´ä¿®æ”¹è¿™äº›å˜é‡ä»¥é€‚åº”ä¸åŒç¯å¢ƒï¼š

```bash
# å¼€å‘ç¯å¢ƒ
EC2_INSTANCE_ID="i-dev-instance-id"
BUCKET_NAME="dev-bucket"

# ç”Ÿäº§ç¯å¢ƒ
EC2_INSTANCE_ID="i-prod-instance-id"
BUCKET_NAME="prod-bucket"
```

